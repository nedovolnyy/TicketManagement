@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Mvc.Localization
@using TicketManagement.Common.DI
@using TicketManagement.Common.Entities
@using TicketManagement.MVC.Helpers

@inject IAuthorizationService AuthorizationService
@inject IServiceProvider ServiceProvider
@inject IViewLocalizer Localizer
@inject IEventService EventService

@model IEnumerable<Event>

@{
    ViewBag.Title = @Localizer["Home Page"];
    var isManageRole = User.IsInRole("Administrator") || User.IsInRole("EventManager");
}

@if (isManageRole)
{
    <div class="text-sm-center">
        <h5 class="display-4">@Localizer["Total Events:"] @((await EventService.GetAllAsync()).Count())</h5>
    </div>
}

<div class="row">
    @Html.Raw($"<table class='table'>")
    @foreach (var evnt in Model)
    {
        if ((evnt.Id % 2) != default)
        {
            @Html.Raw("<tr>")
        }
        @Html.Raw("<td>")
        <form id="@Html.Raw("evnt"+evnt.Id)" asp-controller="Event" asp-action="Index"
          asp-route-eventId="@evnt.Id" method="post" class="form-horizontal" role="form">
            <button type="submit" class="invisible">
                <div class="img__container visible">
                    <img class="image shadow-lg" alt="" src="@Url.Content(evnt.EventLogoImage)" />
                    <div class="img__description">
                        <div class="text">
                            <div class="img__header right" style="font-size: 0.75em;">@Html.ModifyDateTime(evnt.EventTime)</div>
                            <div class="img__header left"><h2 style="text-decoration: none;">@evnt.Name</h2></div>
                        </div>
                        <div class="text">
                            <div class="left">
                                <p>@evnt.Description</p>
                            </div>
                            <div class="right">
                                <p>@(await EventService.GetSeatsAvailableCountAsync(evnt.Id)) / @(await EventService.GetSeatsCountAsync(evnt.LayoutId))</p>
                            </div>
                        </div>
                        <div class="text">
                            <div class="right">
                                <p style="font-size: 0.75em;">@Localizer["Avalaible"]</p>
                            </div>
                        </div>
                    </div>
                </div>
            </button>
        </form>
        @if (isManageRole)
        {
            @Html.Raw("<td>")
            <form asp-action="Delete" asp-controller="EventManagement" asp-route-eventId="@evnt.Id" method="post">
                <a class="btn btn-sm btn-primary" asp-action="Edit" asp-controller="EventManagement" asp-route-eventId="@evnt.Id">@Localizer["Edit"]</a>
                @if (await EventService.IsAllAvailableSeatsAsync(evnt.Id))
                {
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this event?')" >@Localizer["Delete"]</button>
                }
            </form>
            @Html.Raw("</td>")
        }
        @Html.Raw("</td>")
        if ((evnt.Id % 2) == default || (evnt.Id == Model.Count() && (evnt.Id % 2) != default))
        {
            @Html.Raw("</tr>")
        }
    }
    @Html.Raw("</table>")
</div>

